<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="formatting/manifest.json" />
    <link rel="stylesheet" href="formatting/style.css" />
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("sw.js");
        });
      }
    </script>
    <meta charset="UTF-8" />
    <title>Arxiv Scroller</title>
  </head>

  <body>
    <div id="selection">
      <button data-subject="combo">combo</button>
      <button data-subject="prob">prob</button>
      <button data-subject="nt">nt</button>
      <button data-subject="misc">misc</button>
    </div>

    <div id="card" style="display: none">
      <button id="back-button">â€¹</button>
      <div id="card-content-wrapper"></div>
    </div>

    <script>
      const selection = document.getElementById("selection");
      const card = document.getElementById("card");
      const cardContent = document.getElementById("card-content-wrapper");
      const backButton = document.getElementById("back-button");

      const CATEGORIES = {
        combo: ["math.CO"],
        prob: ["math.PR"],
        nt: ["math.NT"],
        misc: ["math.DS", "math.DG", "math.HO"],
      };

      let papers = [],
        i = 0,
        subject = "",
        next_date = new Date();

      function datestr(d) {
        return d.toLocaleDateString("en-CA", { timeZone: "America/New_York" });
      }

      async function load() {
        const date = datestr(next_date);
        try {
          const r = await fetch(`papers/${date}.json`);
          if (!r.ok) throw new Error();
          const all = await r.json();
          const filtered = all.filter((p) =>
            p.categories?.some((c) => (CATEGORIES[subject] || []).includes(c))
          );
          if (filtered.length === 0) {
            return [{ type: "no_papers", date: date.slice(5) }];
          }
          const tot = filtered.length;
          return filtered.map((p, idx) => ({
            ...p,
            index: idx + 1,
            tot,
            type: "paper",
          }));
        } catch (e) {
          return [{ type: "no_papers", date: date.slice(5) }];
        }
      }

      function display(item) {
        if (item.type === "no_papers") {
          cardContent.innerHTML = `
            <p>${item.date}</p>
            <br><br><br>
            <h2>No papers found</h2>
          `;
        } else {
          cardContent.innerHTML = `
            <p>${item.date} (${item.index}/${item.tot})</p>
            <br>
            <h2><a href="${item.link}" target="_blank">${item.title}</a></h2>
            <p>${item.abstract.split(/\s+/).slice(0, 30).join(" ")}...</p>
          `;
        }
        if (window.MathJax) {
          MathJax.typesetPromise([cardContent]);
        }
      }

      async function show() {
        if (i >= papers.length) {
          const more = await load();
          papers.push(...more);
          next_date.setDate(next_date.getDate() - 1);
        }
        display(papers[i]);
      }

      selection.onclick = (e) => {
        if (e.target.dataset.subject) {
          subject = e.target.dataset.subject;
          i = 0;
          papers = [];
          next_date = new Date();
          selection.style.display = "none";
          card.style.display = "flex";
          show();
        }
      };

      backButton.onclick = (e) => {
        e.stopPropagation();
        card.style.display = "none";
        selection.style.display = "flex";
      };

      card.onclick = (e) => {
        if (e.target.closest("a") || e.target.id === "back-button") return;
        const y =
          (e.clientY - card.getBoundingClientRect().top) /
          card.getBoundingClientRect().height;
        if (y < 0.2) {
          i = Math.max(0, i - 1);
          show();
        } else if (y > 0.8) {
          i++;
          show();
        }
      };
    </script>
    <script>
      MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
          displayMath: [
            ["$$", "$$"],
            ["\\[", "\\]"],
          ],
        },
        chtml: {
          scale: 0.85,
        },
      };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
  </body>
</html>
